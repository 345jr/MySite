<template>
    <div v-show="visible" ref="musicMenu"
        class="absolute right-0 top-1 mt-18 w-56 bg-white rounded-b-lg shadow-xl z-50 border border-gray-200 overflow-hidden">
        <div class="max-h-60 overflow-y-auto py-1">
            <div class="px-3 py-2 text-sm text-gray-500 bg-gray-50 border-b">
                当前播放: {{ currentSong ? formatSongName(currentSong) : "无" }}
            </div>
            <a v-for="(song, index) in songList" :key="song" @click="selectSong(song)"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-100 transition-colors duration-200 cursor-pointer"
                :class="{ 'bg-blue-50': currentSong === song }">
                <span class="text-blue-500 mr-2">{{ index + 1 }}.</span>
                {{ formatSongName(song) }}
            </a>
        </div>
    </div>
    <audio ref="audioPlayer" v-if="currentSong" :src="`https://music.lopop.top/api/bgm?name=${currentSong}`"></audio>
</template>

<script setup>
import axios from "axios";
import { ref, onMounted } from "vue";
import { watch } from 'vue';

const props = defineProps({
    visible:Boolean,
    playMusic:Boolean
});

const emit = defineEmits(['select-song']);
const audioPlayer = ref(null);
const songList = ref([]);
const currentSong = ref(null);

// 格式化歌名
const formatSongName = (song) => {
  return song.replace(/^music\//, "").replace(/\.(mp3|flac|wav|ogg|mp4)$/, "");
};

// 获取歌曲列表
const fetchSongs = async () => {
    try {
        const response = await axios.get("https://music.lopop.top/api/songs");
        songList.value = response.data;
        if (songList.value.length > 0) {
            currentSong.value = songList.value[0];
        }
    } catch (error) {
        console.error("获取歌曲列表失败:", error);
    }
};

// 选择歌曲
const selectSong = async (song) => {
  try {
    // 暂停当前播放
    if (audioPlayer.value && !audioPlayer.value.paused) {
      audioPlayer.value.pause();
    }
    currentSong.value = song;
    if (audioPlayer.value) {
      // 设置新音频源
      audioPlayer.value.src = `https://music.lopop.top/api/bgm?name=${song}`;
      // 等待音频加载
      await new Promise((resolve, reject) => {
        audioPlayer.value.onloadedmetadata = resolve;
        audioPlayer.value.onerror = reject;
      });
      // 如果之前是播放状态，则播放新歌曲
      if (props.playMusic) {
        await audioPlayer.value.play();
      }
    }
    emit('select-song', song);
  } catch (error) {
    console.error("播放歌曲失败:", error);
  }
};

watch(
  () => props.playMusic,
  async (newVal) => {
    if (audioPlayer.value) {
      if (newVal) {
        try {
          await audioPlayer.value.play();
        } catch (error) {
          console.error("播放失败:", error);
        }
      } else {
        audioPlayer.value.pause();
      }
    }
  }
);



onMounted(() => {
  fetchSongs();
});

</script>